## 6.内存基础

### 6.1 基本概念

#### 6.1.1 内存

内存是进程运行的载体，操作系统将程序放入内存从而创建进程实体。

#### 6.1.2 单位

1B = 8bit

1KB = 1024B = 2^10B = 2^13 bits

1MB = 1024x1024B = 2^20B = 2^23 bits

1GB = 1024x1024x1024B = 2^30B = 2^33 bits

> 计算机、网络流量、内存等默认使用KiB，简记为KB （kilo-binary Bytes），1024为底
>
> 硬盘厂商默认使用KB（kilo Bytes），1000为底

#### 6.1.3 存储单元与物理地址编址

内存中最小的单位是存储单元，每个存储单元都有一个唯一的地址，根据地址编址方式的不同，存储单元的大小也不同，常见的地址编址方式有

- 按字节编址

  即每8位编一个地址，此时一个存储单元的大小就是一个字节，也即1B

- 按字编址

  即每一个字长多个二进制数编一个地址，此时一个存储单元的大小就是一个字，如果字长是16位，那么存储单元的长度也是16位
  
  > 不论如何，一个地址都对应于一个存储单元，只不过存储单元中存储的字节数不同

![image-20201115215819192](https://cdn.jsdelivr.net/gh/linkins1/MyNoteBooks/resources/imgs/os/image-20201115215819192123.png)

> **按字节编址**，顾名思义就是每8位数据编一个地址，地址一般**以字节为单位**进行计量，所以按字节编址时，地址号是按1递增的
>
> **按字编址**时，如果字长为16位，每个存储单元包含两个字节，那么地址号此时只剩下偶数号可以使用，且**寻址范围**，也即不同的地址号的个数相较于按字节编址少了一半（由于字长是16位）

#### 6.1.4 存储容量

$$
存储容量=存储单元个数*字长 bits
$$

如果以字节为单位需要除以8

一般为给定存储容量的大小，去推算存储单元个数也即地址容量，从而推出地址总线的条数，举例如下

***如果内存的容量为16MB，字长32位，按字编址，需要多少地址总线？***

由于容量为16MB=2^24B，如果按字节编址，地址容量（寻址范围）为2^24，地址范围是0-2^24-1；如果按字编址，地址容量（寻址范围）为2^24/(32/8)=2^22，地址范围是0-2^22-1，由于每根地址线只有0和1两种状态，那么一根地址线就对应一个二进制位，所以当按字节编址时需要24根地址线，当按字编址时，需要22根地址线

#### 6.1.5 逻辑地址和物理地址

在有地址转换功能的计算机中，

**逻辑地址**即指令中的地址码给出的地址，是**相对地址**；而**物理地址**是指要访问的数据在内存中的真实地址，是**绝对地址**

#### 6.1.6 内存碎片

内存碎片一般指离散的、较小的、无法被利用的内存区域的集合，一般分为两类

- **内部碎片**

  如果对内存进行固定划分且将进程分配在一个独立的划分中，在此情况下，如果进程实际占用的内存**小于**固定分配的内存，由于固定分配的内存区域一般是**独占的**，无法被其他进程使用，那么被闲置的内存就被称为**内部碎片**

- **外部碎片**

  指为每个进程分配刚好满足进程要求的内存空间，且可以动态分配，不论在连续还是非连续的内存分配方式下，由于不同进程占用内存的总和与区域很难刚好填满整个内存，那么那些**卡在**不同进程所占用的内存区域**之间**的内存就是**外部碎片**

### 6.2 进程创建流程

对于一般的C代码来说，创建进程分为如下几步

**预处理- >编译->汇编->链接->装入**

在链接过后，一个完整的可执行文件就已经创建完成，最后将程序中的指令装入到内存中开始执行

#### 6.2.1 链接

链接根据方式和时机不同分为三种

##### 1）静态链接

在链接时将程序用到的全部库函数与编译后的代码链接为一个完整的可执行文件

##### 2）装入时动态链接

在将可执行文件装入到内存中时一边装入一边进行链接

##### 3）运行时动态链接

在进程运行过程中，如果需要到库函数，再临时完成链接

#### 6.2.2 装入

**装入**要完成的主要任务是将指令中的地址码（逻辑地址）映射到内存中的物理地址上，根据逻辑地址到物理地址的映射方式的不同，装入的方式也不同

##### 1） 绝对装入

###### （1）定义

在编译时如果知道程序将放到哪块内存上，那么编译时就会产生带有**绝对地址**的指令，这样只需要按照指令中的地址进行装入即可

###### （2）特性

适用于单道处理程序

##### 2） 静态重定位

###### （1）定义

又称为可重定位装入，指在编译、链接后的指令中的地址为**逻辑地址**，根据内存的使用情况，将逻辑地址进行重定位，也即映射为物理地址后**一次性**装入到内存中

###### （2）特性

- 要求在内存上分配连续的内存空间，如果内存不足，则不进行装入
- 一旦装入内存，就不再移动
- 适用于多道批处理系统

##### 3） 动态重定位

###### （1）定义

又称为在运行时动态装入，指在编译、链接后的指令中的地址为逻辑地址，但是**不会一次性**将逻辑地址翻译为物理地址，而是在程序真正需要**运行时再进行地址转换**

###### （2）特性

- 被装入内存后仍然保持逻辑地址，在运行时才进行地址转换
- 需要重定位寄存器中记录内存中**可用的初始物理地址**，用这个物理地址与逻辑地址加和得到实际的物理地址
- 适用于现代操作系统

